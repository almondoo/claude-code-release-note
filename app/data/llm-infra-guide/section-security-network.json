{
  "id": "security-network",
  "title": "ネットワークセキュリティ",
  "description": "プライベート接続とゼロトラストの実装",
  "blocks": [
    {
      "type": "text",
      "content": "LLM APIへの通信は機密性の高いプロンプトとレスポンスを含むため、通信経路のセキュリティが極めて重要です。パブリックインターネット経由のAPI呼び出しは盗聴リスクがあり、TLS暗号化だけでは不十分な場合があります。さらに、LLMのエージェント機能（ツール利用、外部API呼び出し）が普及するにつれ、{{egress-control}}が新たな課題となっています。{{private-link}}と{{zero-trust}}を組み合わせた多層防御が推奨されます。"
    },
    {
      "type": "list",
      "ordered": false,
      "items": [
        "**プライベート接続の優先**: 可能な限りパブリックインターネットを経由しない接続経路を選択する",
        "**多層防御**: ネットワーク層、トランスポート層、アプリケーション層の各レベルでセキュリティ制御を実装",
        "**{{zero-trust}}**: ネットワーク位置に基づく暗黙の信頼を排除し、すべてのアクセスを検証する",
        "**最小通信原則**: 必要な通信のみを許可し、不要なEgressを遮断する"
      ]
    },
    {
      "type": "table",
      "caption": "Private Link比較（AWS/Azure/GCP）",
      "headers": [
        "クラウド",
        "サービス",
        "LLM対応",
        "構成概要"
      ],
      "rows": [
        [
          "AWS",
          "PrivateLink + VPC Endpoint",
          "Bedrock (VPC Endpoint対応)",
          "VPCエンドポイントを作成し、Bedrockへの通信をAWSバックボーン内に閉じる"
        ],
        [
          "Azure",
          "Private Endpoint",
          "Azure OpenAI (Private Endpoint対応)",
          "Private EndpointでプライベートIP経由アクセスを確立。パブリックアクセスを無効化"
        ],
        [
          "GCP",
          "Private Service Connect",
          "Vertex AI (VPC-SC対応)",
          "Private Service Connectエンドポイントを作成。VPC-SCによりデータ持ち出しも制御"
        ]
      ]
    },
    {
      "type": "codeBlock",
      "language": "hcl",
      "title": "AWS PrivateLink Terraform",
      "filename": "bedrock-vpc-endpoint.tf",
      "code": "resource \"aws_vpc_endpoint\" \"bedrock\" {\n  vpc_id              = aws_vpc.main.id\n  service_name        = \"com.amazonaws.ap-northeast-1.bedrock-runtime\"\n  vpc_endpoint_type   = \"Interface\"\n  subnet_ids          = aws_subnet.private[*].id\n  security_group_ids  = [aws_security_group.bedrock_endpoint.id]\n  private_dns_enabled = true  # プライベートDNSで名前解決\n\n  tags = { Name = \"bedrock-vpc-endpoint\" }\n}\n\nresource \"aws_security_group\" \"bedrock_endpoint\" {\n  vpc_id = aws_vpc.main.id\n  ingress {\n    from_port       = 443\n    to_port         = 443\n    protocol        = \"tcp\"\n    security_groups = [aws_security_group.llm_gateway.id]\n  }\n}",
      "caption": "ゲートウェイからのみVPCエンドポイントへのアクセスを許可するSG設計"
    },
    {
      "type": "table",
      "caption": "WAF/API Gateway制御一覧",
      "headers": [
        "制御",
        "実装",
        "目的"
      ],
      "rows": [
        [
          "レート制限",
          "API Gateway throttling（ユーザー/APIキー単位）",
          "DoS攻撃防御、コスト制御"
        ],
        [
          "ペイロードサイズ制限",
          "API Gateway: max 10MB、WAFルールでbody size検査",
          "リソース枯渇防止"
        ],
        [
          "IPフィルタリング",
          "WAF IP Sets / Security Group",
          "許可IPレンジからのアクセスのみ許可"
        ],
        [
          "地理的制限",
          "WAF Geo-match",
          "特定リージョンからのアクセスブロック"
        ],
        [
          "異常検知",
          "AWS WAF Bot Control / カスタムルール",
          "異常なリクエストパターンの検出"
        ]
      ]
    },
    {
      "type": "text",
      "content": "**ゼロトラストアーキテクチャ**: LLM通信経路に{{zero-trust}}を適用する場合、信頼境界はリクエストの「各ホップ」に設定します。BeyondCorp / ZTNAの考え方に基づき、{{iap}}（Google IAP / Azure AD Application Proxy / Cloudflare Access）をLLMゲートウェイの前段に配置し、ユーザー認証とデバイスポスチャーチェックを行ったうえでアクセスを許可する構成が推奨されます。"
    },
    {
      "type": "codeBlock",
      "language": "yaml",
      "title": "K8s NetworkPolicy（Egress制御）",
      "filename": "llm-agent-egress.yaml",
      "code": "apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: llm-agent-egress\n  namespace: llm-platform\nspec:\n  podSelector:\n    matchLabels:\n      app: llm-agent\n  policyTypes:\n    - Egress\n  egress:\n    # 許可: LLM API (PrivateLink経由)\n    - to:\n        - ipBlock:\n            cidr: 10.0.100.0/24  # VPC Endpointのサブネット\n      ports:\n        - port: 443\n          protocol: TCP\n    # 許可: 社内APIのみ\n    - to:\n        - namespaceSelector:\n            matchLabels:\n              name: internal-apis\n      ports:\n        - port: 443\n          protocol: TCP\n    # DNS\n    - to: []\n      ports:\n        - port: 53\n          protocol: UDP",
      "caption": "LLMエージェントの外部通信をホワイトリスト方式で厳密に制御"
    },
    {
      "type": "infraDiagram",
      "variant": "cloudArch",
      "title": "AWS LLMセキュリティアーキテクチャ",
      "caption": "VPC設計とセキュリティレイヤーの配置。全トラフィックがPrivate Subnet内のLLMゲートウェイを経由する構成",
      "provider": "aws",
      "layers": [
        {
          "label": "Public Subnet",
          "color": "#FEF3C7",
          "services": [
            {
              "name": "ALB",
              "description": "Application Load Balancer"
            },
            {
              "name": "AWS WAF",
              "description": "レート制限 / ペイロード検査 / Geo制限"
            }
          ]
        },
        {
          "label": "Private Subnet (Application)",
          "color": "#DBEAFE",
          "services": [
            {
              "name": "API Gateway",
              "description": "REST / HTTP"
            },
            {
              "name": "Lambda Authorizer",
              "description": "JWT検証 / RBAC・ABACチェック / OPA評価"
            },
            {
              "name": "LLM Gateway",
              "description": "Portkey / LiteLLM / Custom"
            },
            {
              "name": "DLP Engine",
              "description": "PII検出 / 機密情報マスキング"
            },
            {
              "name": "入力ガードレール",
              "description": "Prompt Injection検出 / ブロックリスト"
            },
            {
              "name": "出力ガードレール",
              "description": "有害コンテンツ検出 / スキーマ検証"
            }
          ]
        },
        {
          "label": "Private Subnet (Data)",
          "color": "#FCE7F3",
          "services": [
            {
              "name": "Secrets Manager",
              "description": "APIキー管理"
            },
            {
              "name": "KMS",
              "description": "暗号化キー管理"
            },
            {
              "name": "S3",
              "description": "監査ログ保管（KMS暗号化）"
            },
            {
              "name": "OpenSearch",
              "description": "ログ検索・分析"
            }
          ]
        },
        {
          "label": "LLM Providers (PrivateLink)",
          "color": "#D1FAE5",
          "services": [
            {
              "name": "AWS Bedrock",
              "description": "Claude / Titan"
            },
            {
              "name": "外部API",
              "description": "OpenAI / Anthropic（PrivateLink経由）"
            }
          ]
        }
      ]
    },
    {
      "type": "infraDiagram",
      "variant": "network",
      "title": "ゼロトラスト LLMネットワーク構成",
      "caption": "Identity-Aware Proxy、Istio mTLS、マイクロセグメンテーションを適用した構成",
      "zones": [
        {
          "label": "External Trust Boundary",
          "color": "#FEE2E2",
          "items": [
            {
              "label": "ユーザー",
              "sublabel": "デバイス（MDM管理）"
            }
          ]
        },
        {
          "label": "Edge Trust Boundary",
          "color": "#FEF3C7",
          "items": [
            {
              "label": "Identity-Aware Proxy",
              "sublabel": "デバイスポスチャー / OIDC認証 / コンテキスト判定"
            }
          ]
        },
        {
          "label": "llm-gateway (mTLS STRICT)",
          "color": "#DBEAFE",
          "items": [
            {
              "label": "LLM Gateway"
            }
          ]
        },
        {
          "label": "llm-security (mTLS STRICT)",
          "color": "#EDE9FE",
          "items": [
            {
              "label": "DLP / Guardrails",
              "sublabel": "PII検出 / Prompt検証"
            }
          ]
        },
        {
          "label": "llm-inference (mTLS STRICT)",
          "color": "#D1FAE5",
          "items": [
            {
              "label": "推論サーバー",
              "sublabel": "vLLM / TGI"
            }
          ]
        },
        {
          "label": "llm-tools (mTLS STRICT)",
          "color": "#FCE7F3",
          "items": [
            {
              "label": "ツール実行サンドボックス",
              "sublabel": "Egress制限 / ReadOnly FS"
            }
          ]
        }
      ],
      "connections": [
        {
          "from": "ユーザー",
          "to": "Identity-Aware Proxy",
          "label": "TLS 1.3",
          "style": "solid"
        },
        {
          "from": "Identity-Aware Proxy",
          "to": "LLM Gateway",
          "label": "JWT付与",
          "style": "solid"
        },
        {
          "from": "LLM Gateway",
          "to": "DLP / Guardrails",
          "label": "mTLS",
          "style": "solid"
        },
        {
          "from": "DLP / Guardrails",
          "to": "推論サーバー",
          "label": "mTLS",
          "style": "solid"
        },
        {
          "from": "推論サーバー",
          "to": "ツール実行サンドボックス",
          "label": "mTLS",
          "style": "dashed"
        }
      ]
    },
    {
      "type": "infraDiagram",
      "variant": "network",
      "title": "マルチクラウド/ハイブリッド構成",
      "caption": "オンプレミスのプライベートモデルとクラウドの商用APIを併用する構成",
      "zones": [
        {
          "label": "オンプレミス データセンター",
          "color": "#E0E7FF",
          "items": [
            {
              "label": "プライベートモデル",
              "sublabel": "Llama / Mistral (GPU: H100×8)"
            },
            {
              "label": "推論サーバー",
              "sublabel": "vLLM + TGI"
            },
            {
              "label": "オンプレミス GW",
              "sublabel": "ローカルDLP / キャッシュ"
            }
          ]
        },
        {
          "label": "統一 LLM ゲートウェイ",
          "color": "#FEF3C7",
          "items": [
            {
              "label": "リクエストルーター",
              "sublabel": "データ分類に基づくルーティング"
            },
            {
              "label": "ポリシーエンジン (OPA)"
            },
            {
              "label": "統一DLPレイヤー"
            },
            {
              "label": "セマンティックキャッシュ",
              "sublabel": "Redis + Embedding"
            }
          ]
        },
        {
          "label": "クラウドプロバイダー",
          "color": "#D1FAE5",
          "items": [
            {
              "label": "AWS Bedrock",
              "sublabel": "ap-northeast-1"
            },
            {
              "label": "Azure OpenAI",
              "sublabel": "Japan East"
            },
            {
              "label": "GCP Vertex AI",
              "sublabel": "asia-northeast1"
            }
          ]
        }
      ],
      "connections": [
        {
          "from": "リクエストルーター",
          "to": "ポリシーエンジン (OPA)",
          "label": "ポリシー評価",
          "style": "solid"
        },
        {
          "from": "統一DLPレイヤー",
          "to": "オンプレミス GW",
          "label": "Restricted データ",
          "style": "solid"
        },
        {
          "from": "統一DLPレイヤー",
          "to": "AWS Bedrock",
          "label": "Confidential（日本）",
          "style": "dashed"
        },
        {
          "from": "統一DLPレイヤー",
          "to": "Azure OpenAI",
          "label": "Confidential（日本）",
          "style": "dashed"
        },
        {
          "from": "統一DLPレイヤー",
          "to": "GCP Vertex AI",
          "label": "Internal データ",
          "style": "dashed"
        }
      ]
    },
    {
      "type": "subsection",
      "title": "パターン別推奨構成",
      "blocks": [
        {
          "type": "list",
          "ordered": false,
          "items": [
            "**パターンA（API直接利用）**: TLS 1.3必須。可能であれば{{private-link}}利用。{{egress-control}}はファイアウォール/プロキシで許可ドメインをホワイトリスト化",
            "**パターンB（ゲートウェイ経由）**: WAF → API Gateway → Lambda Authorizer → LLM Gatewayの多層構成。Private Link経由でLLM APIに接続。Private Subnet + NLBで構成",
            "**パターンC（プライベートホスティング）**: 完全にVPC内で完結。推論サーバーはPrivate Subnetに配置し外部通信を一切遮断。Istio STRICT {{mtls}}で全通信を暗号化・認証"
          ]
        }
      ]
    },
    {
      "type": "checklist",
      "categories": [
        {
          "name": "ネットワークセキュリティチェックリスト",
          "items": [
            "LLM APIへの接続がPrivate Link / Private Endpoint経由で構成されている",
            "TLS 1.3が全通信経路で適用されている",
            "WAF / API Gatewayによるレート制限・ペイロード検査が有効化されている",
            "ゼロトラスト原則に基づき、全リクエストの認証・認可が実装されている",
            "LLMエージェントのEgress通信がホワイトリストで制限されている",
            "ネットワークフローログが取得・監視されている",
            "マイクロセグメンテーションにより不要な通信が遮断されている"
          ]
        }
      ]
    },
    {
      "type": "reactFlowDiagram",
      "diagramId": "zero-trust"
    },
    {
      "type": "reactFlowDiagram",
      "diagramId": "multi-cloud"
    }
  ]
}
